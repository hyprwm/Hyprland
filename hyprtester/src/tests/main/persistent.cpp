#include "tests.hpp"
#include "../../shared.hpp"
#include "../../hyprctlCompat.hpp"
#include <print>
#include <thread>
#include <chrono>
#include <hyprutils/os/Process.hpp>
#include <hyprutils/memory/WeakPtr.hpp>
#include <csignal>
#include <cerrno>
#include "../shared.hpp"

static int ret = 0;

using namespace Hyprutils::OS;
using namespace Hyprutils::Memory;

#define UP CUniquePointer
#define SP CSharedPointer

static bool test() {
    NLog::log("{}Testing persistent workspaces", Colors::GREEN);

    EXPECT(Tests::windowCount(), 0);

    // test on workspace "window"
    NLog::log("{}Switching to workspace 1", Colors::YELLOW);
    getFromSocket("/dispatch workspace 1"); // no OK: we might be on 1 already

    OK(getFromSocket("/keyword workspace 5, monitor:HEADLESS-2, persistent:1"));
    OK(getFromSocket("/keyword workspace 6, monitor:HEADLESS-PERSISTENT-TEST, persistent:1"));
    OK(getFromSocket("/keyword workspace name:PERSIST, monitor:HEADLESS-PERSISTENT-TEST, persistent:1"));
    OK(getFromSocket("/keyword workspace name:PERSIST-2, monitor:HEADLESS-PERSISTENT-TEST, persistent:1"));

    {
        auto str = getFromSocket("/workspaces");
        EXPECT_CONTAINS(str, "ID 5 (5)");
        EXPECT_COUNT_STRING(str, "workspace ID ", 2);
    }

    OK(getFromSocket("/output create headless HEADLESS-PERSISTENT-TEST"));

    {
        auto str = getFromSocket("/monitors");
        EXPECT_CONTAINS(str, "HEADLESS-PERSISTENT-TEST");
    }

    OK(getFromSocket("/dispatch focusmonitor HEADLESS-PERSISTENT-TEST"));

    {
        auto str = getFromSocket("/workspaces");
        EXPECT_CONTAINS(str, "ID 2 (2)"); // this should be automatically generated by hl
        EXPECT_CONTAINS(str, "ID 5 (5)");
        EXPECT_CONTAINS(str, "ID 6 (6)");
        EXPECT_CONTAINS(str, "(PERSIST) on monitor");
        EXPECT_CONTAINS(str, "(PERSIST-2) on monitor");
        EXPECT_COUNT_STRING(str, "workspace ID ", 6);
    }

    OK(getFromSocket("/reload"));

    {
        auto str = getFromSocket("/workspaces");
        EXPECT_NOT_CONTAINS(str, "ID 5 (5)");
        EXPECT_NOT_CONTAINS(str, "ID 6 (6)");
        EXPECT_NOT_CONTAINS(str, "(PERSIST) on monitor");
        EXPECT_COUNT_STRING(str, "workspace ID ", 2);
    }

    // Test position-based monitor selection
    NLog::log("{}Testing position-based monitor selection", Colors::YELLOW);

    // Get the position of HEADLESS-PERSISTENT-TEST monitor
    std::string monitorPos;
    {
        auto str = getFromSocket("/monitors");
        auto pos = str.find("HEADLESS-PERSISTENT-TEST");
        if (pos != std::string::npos) {
            // Find "at XxY" for this monitor (format is: "1280x720@60Hz at 1280x0")
            auto atPos = str.find("at ", pos);
            if (atPos != std::string::npos) {
                auto lineEnd  = str.find("\n", atPos);
                auto posStart = atPos + 3;
                // Skip any whitespace after "at "
                while (posStart < lineEnd && std::isspace(str[posStart]))
                    posStart++;
                // Extract position until whitespace or newline
                auto posEnd = posStart;
                while (posEnd < lineEnd && !std::isspace(str[posEnd]))
                    posEnd++;
                monitorPos = str.substr(posStart, posEnd - posStart);
            }
        }
    }

    NLog::log("{}HEADLESS-PERSISTENT-TEST monitor at position {}", Colors::YELLOW, monitorPos);

    // Test 1: Normal position (XxY format)
    const auto ws7Rule =
        "/keyword workspace 7, monitor:position:" + monitorPos + ", persistent:1";
    OK(getFromSocket(ws7Rule));

    {
        auto str = getFromSocket("/workspaces");
        EXPECT_CONTAINS(str, "ID 7 (7)");
        EXPECT_CONTAINS(str, "on monitor HEADLESS-PERSISTENT-TEST");
    }

    // Test 2: Relative position (r-Xxb-Y format)
    NLog::log("{}Testing relative position r-0xb-0", Colors::YELLOW);
    OK(getFromSocket("/keyword workspace 8, monitor:position:r-0xb-0, persistent:1"));

    {
        auto str = getFromSocket("/workspaces");
        EXPECT_CONTAINS(str, "ID 8 (8)");
        EXPECT_CONTAINS(str, "on monitor HEADLESS-PERSISTENT-TEST");
    }

    // Test 3: Invalid position (fallback to monitor ID 0)
    NLog::log("{}Testing invalid position 9999x9999 (fallback)", Colors::YELLOW);
    OK(getFromSocket("/keyword workspace 9, monitor:position:9999x9999, persistent:1"));

    {
        auto str = getFromSocket("/workspaces");
        EXPECT_CONTAINS(str, "ID 9 (9)");
        EXPECT_NOT_CONTAINS(str, "ID 9 (9) on monitor HEADLESS-PERSISTENT-TEST");
    }

    NLog::log("{}Cleaning up position-based test workspaces", Colors::YELLOW);
    OK(getFromSocket("/reload"));

    OK(getFromSocket("/output remove HEADLESS-PERSISTENT-TEST"));

    // kill all
    NLog::log("{}Killing all windows", Colors::YELLOW);
    Tests::killAllWindows();

    NLog::log("{}Expecting 0 windows", Colors::YELLOW);
    EXPECT(Tests::windowCount(), 0);

    // reload cfg
    OK(getFromSocket("/reload"));

    return !ret;
}

REGISTER_TEST_FN(test)
