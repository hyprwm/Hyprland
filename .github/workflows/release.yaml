name: Release artifacts

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  source-tarball:
    runs-on: ubuntu-latest
    container:
      image: archlinux
    steps:
      - name: Checkout repository actions
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/actions

      - name: Setup base
        uses: ./.github/actions/setup_base

      - name: Generate version
        run: |
          cmake -S . -B /tmp/build

      - name: Create tarball with submodules
        id: tar
        run: |
          mkdir hyprland-source; mv ./* ./hyprland-source || tar -czv --owner=0 --group=0 --no-same-owner --no-same-permissions -f source.tar.gz *

      - id: whatrelease
        name: Get latest release
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          owner: hyprwm
          repo: Hyprland
          excludes: prerelease, draft

      - name: Upload to release
        id: upload
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: source.tar.gz
          asset_name: source-${{ steps.whatrelease.outputs.release }}.tar.gz
          tag: ${{ steps.whatrelease.outputs.release }}
          overwrite: true
